using System;
using System.Collections.Generic;
using System.Linq;
using System.Data.SqlClient;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.EntityFramework;

namespace EC1ContinuousAssessment_2005734
{
    public partial class Products : System.Web.UI.Page
    {
        private string connectionString = "Data Source=OMERTA\\SQLEXPRESS;Initial Catalog=AdagioMgmt;Integrated Security=True;";
        protected List<Product> products = new List<Product>();

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                FetchProducts();
                SetVisibilityBasedOnUserRole();
            }
        }

        private void FetchProducts()
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();

                // Fetch products from the database
                string fetchProductsQuery = "SELECT * FROM Product";
                using (SqlCommand fetchProductsCommand = new SqlCommand(fetchProductsQuery, connection))
                {
                    using (SqlDataReader reader = fetchProductsCommand.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            // Populate products list
                            Product product = new Product(
                                (int)reader["ProductID"],
                                reader["ProductName"].ToString(),
                                (decimal)reader["Price"],
                                reader["Description"].ToString(),
                                reader["ImageUrl"].ToString()
                            );

                            products.Add(product);
                        }
                    }

                    // Bind the products list to the Repeater control
                    productRepeater.DataSource = products;
                    productRepeater.DataBind();

                    // Populate the dropdown lists with quantity values in the Repeater control
                    foreach (RepeaterItem item in productRepeater.Items)
                    {
                        if (item.ItemType == ListItemType.Item || item.ItemType == ListItemType.AlternatingItem)
                        {
                            DropDownList ddlQuantity = (DropDownList)item.FindControl("ddlQuantity");

                            // Populate the dropdown with quantity values from 1 to 10 (adjust as needed)
                            for (int i = 1; i <= 10; i++)
                            {
                                ddlQuantity.Items.Add(new ListItem(i.ToString(), i.ToString()));
                            }

                            ddlQuantity.CssClass = "quantity-input";
                        }
                    }
                }

                // Explicitly close the connection
                connection.Close();
            }
        }

        private void SetVisibilityBasedOnUserRole()
        {
            if (User.Identity.IsAuthenticated)
            {
                string userId = User.Identity.GetUserId();
                var userManager = new UserManager<AdagioUser>(new UserStore<AdagioUser>(new AdagioDBContext()));

                if (userManager.IsInRole(userId, "admin"))
                {
                    // User is an admin, show admin buttons
                    SetButtonsVisibility(true);
                }
                else
                {
                    // User is not an admin, show customer buttons
                    SetButtonsVisibility(false);
                }
            }
            else
            {
                // User is not logged in, hide all buttons
                SetButtonsVisibility(false);
            }
        }

        private void SetButtonsVisibility(bool isAdmin)
        {
            foreach (RepeaterItem item in productRepeater.Items)
            {
                Button btnAddProduct = (Button)item.FindControl("btnAddProduct");
                Button btnUpdateProduct = (Button)item.FindControl("btnUpdateProduct");
                Button btnDeleteProduct = (Button)item.FindControl("btnDeleteProduct");
                Button btnAddToCart = (Button)item.FindControl("btnAddToCart");
                DropDownList ddlQuantity = (DropDownList)item.FindControl("ddlQuantity");

                if (btnAddProduct != null && btnUpdateProduct != null && btnDeleteProduct != null
                    && btnAddToCart != null && ddlQuantity != null)
                {
                    btnAddProduct.Visible = isAdmin;
                    btnUpdateProduct.Visible = isAdmin;
                    btnDeleteProduct.Visible = isAdmin;
                    btnAddToCart.Visible = !isAdmin;
                    ddlQuantity.Visible = !isAdmin;
                }
            }
        }




        protected void AddToCart_Click(object sender, EventArgs e)
        {
            Button btnAddToCart = (Button)sender;
            RepeaterItem item = (RepeaterItem)btnAddToCart.NamingContainer;
            Label errorMessageLabel = (Label)item.FindControl("errorMessageLabel");
            Label productIDLabel = (Label)item.FindControl("productIDLabel");
            int productid = Convert.ToInt32(productIDLabel.Text);
            DropDownList ddlQuantity = (DropDownList)item.FindControl("ddlQuantity");
            string username;

            if (Session["Username"] == null)
            {
                // User is not logged in, display an error message
                DisplayErrorMessage(errorMessageLabel, "You must be logged in to add products to the cart");
                return;
            }
            else
            {
                // Get the username from the session variable
                string sessionUsername = Session["Username"] as string;

                using (SqlConnection connection = new SqlConnection(connectionString))
                {
                    connection.Open();

                    // Search the database for the username
                    string searchUsernameQuery = "SELECT UserName FROM AspNetUsers WHERE UserName = @Username";
                    using (SqlCommand searchUsernameCommand = new SqlCommand(searchUsernameQuery, connection))
                    {
                        searchUsernameCommand.Parameters.AddWithValue("@Username", sessionUsername);

                        using (SqlDataReader reader = searchUsernameCommand.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                username = reader["UserName"].ToString(); // Set the username from the database
                            }
                            else
                            {
                                // Username not found in the database, you can handle this case
                                DisplayErrorMessage(errorMessageLabel, "User does not exist.");
                                return;
                            }
                        }
                    }
                }
            }

            if (ddlQuantity != null)
            {
                string storedCommandArgument = ddlQuantity.Attributes["data-commandargument"];
                if (!string.IsNullOrEmpty(storedCommandArgument) && storedCommandArgument.Equals("quantity_" + productid))
                {
                    if (int.TryParse(ddlQuantity.SelectedValue, out int quantity))
                    {
                        using (SqlConnection connection = new SqlConnection(connectionString))
                        {
                            connection.Open();

                            string checkExistingProductQuery = "SELECT Quantity FROM ShoppingCart WHERE Username = @Username AND ProductID = @ProductID";

                            using (SqlCommand checkExistingProductCommand = new SqlCommand(checkExistingProductQuery, connection))
                            {
                                checkExistingProductCommand.Parameters.AddWithValue("@Username", username);
                                checkExistingProductCommand.Parameters.AddWithValue("@ProductID", productid);

                                using (SqlDataReader existingProductReader = checkExistingProductCommand.ExecuteReader())
                                {
                                    if (existingProductReader.Read())
                                    {
                                        // Product already exists in the cart, update the quantity
                                        int existingQuantity = (int)existingProductReader["Quantity"];
                                        quantity += existingQuantity;

                                        // Update the quantity in the ShoppingCart table
                                        string updateQuantityQuery = "UPDATE ShoppingCart SET Quantity = @Quantity WHERE Username = @Username AND ProductID = @ProductID";

                                        using (SqlCommand updateQuantityCommand = new SqlCommand(updateQuantityQuery, connection))
                                        {
                                            updateQuantityCommand.Parameters.AddWithValue("@Username", username);
                                            updateQuantityCommand.Parameters.AddWithValue("@ProductID", productid);
                                            updateQuantityCommand.Parameters.AddWithValue("@Quantity", quantity);

                                            updateQuantityCommand.ExecuteNonQuery(); // Save changes to DB
                                        }
                                    }
                                    else
                                    {
                                        existingProductReader.Close();

                                        // Product does not exist in the cart, insert a new record
                                        string insertProductQuery = "INSERT INTO ShoppingCart (Username, ProductID, Quantity) VALUES (@Username, @ProductID, @Quantity)";

                                        using (SqlCommand insertProductCommand = new SqlCommand(insertProductQuery, connection))
                                        {
                                            insertProductCommand.Parameters.AddWithValue("@Username", username);
                                            insertProductCommand.Parameters.AddWithValue("@ProductID", productid);
                                            insertProductCommand.Parameters.AddWithValue("@Quantity", quantity);
                                            insertProductCommand.ExecuteNonQuery(); // Save changes to DB
                                        }
                                    }
                                }
                            }

                            connection.Close();

                            // Display a success message
                            errorMessageLabel.Text = "Added to Cart!";
                            errorMessageLabel.ForeColor = System.Drawing.Color.Green;
                        }

                    }
                    else
                    {
                        DisplayErrorMessage(errorMessageLabel, "Quantity must be a valid number.");
                    }
                }
                else
                {
                    DisplayErrorMessage(errorMessageLabel, "Please provide a quantity.");
                }
            }
        }

        protected void btnAddProductToDB_Click(object sender, EventArgs e)
        {
            Response.Redirect("AddProduct.aspx");
        }

        protected void btnUpdateProduct_Click(object sender, EventArgs e)
        {
            if (sender is Button btn)
            {
                if (btn.CommandName == "UpdateProduct")
                {
                    // Retrieve the product ID from the CommandArgument
                    if (int.TryParse(btn.CommandArgument, out int productID))
                    {
                        // Gets the product from the database using the productID
                        Product product = GetProductFromDatabase(productID);

                        // Store the product in a session variable
                        Session["SelectedProduct"] = product;

                        // Redirects to the UpdateProduct.aspx page
                        Response.Redirect("UpdateProduct.aspx");
                    }
                }
            }
        }

        protected void btnDeleteProduct_Click(object sender, EventArgs e)
        {
            Button btnDeleteProduct = (Button)sender;
            RepeaterItem item = (RepeaterItem)btnDeleteProduct.NamingContainer;
            Label errorMessageLabel = (Label)item.FindControl("errorMessageLabel");

            if (sender is Button btn)
            {
                if (btn.CommandName == "DeleteProduct")
                {
                    string confirmMessage = "Are you sure you want to delete this product?";

                    // Sets the onclick attribute of the button to bring up the confirmation prompt
                    btn.OnClientClick = "return confirm('" + confirmMessage + "');";

                    // Get the product ID from the CommandArgument
                    int productID;
                    if (int.TryParse(btn.CommandArgument, out productID))
                    {
                        // Delete the product by ID
                        bool prodDelete = DeleteProductFromDatabase(productID);

                        if (prodDelete)
                        {
                            errorMessageLabel.Text = "Product deleted successfully.";
                            Response.Redirect("Products.aspx");
                        }
                        else
                        {
                            // Handle the case when the deletion fails, display an error message, etc.
                            errorMessageLabel.Text = "Failed to delete the product. Please try again.";
                        }
                    }
                    else
                    {
                        // If CommandArgument doesn't contain a valid product ID...
                        errorMessageLabel.Text = "Invalid product ID.";
                    }
                }
            }
        }

        private bool DeleteProductFromDatabase(int productId)
        {
            try
            {
                using (var connection = new SqlConnection(connectionString))
                {
                    connection.Open();

                    // Check if the product with the provided ID exists
                    using (var command = new SqlCommand("SELECT * FROM Product WHERE ProductID = @ProductId", connection))
                    {
                        command.Parameters.AddWithValue("@ProductId", productId);

                        using (var reader = command.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                // Product found, proceed with deletion
                                using (var deleteCommand = new SqlCommand(
                                    "DELETE FROM Product WHERE ProductID = @ProductId", connection))
                                {
                                    deleteCommand.Parameters.AddWithValue("@ProductId", productId);
                                    deleteCommand.ExecuteNonQuery(); // Execute the delete

                                    return true; // Returns true if product was deleted successfully
                                }
                            }
                            else
                            {
                                return false; // Returns false when the product with the given ID was not found in DB
                            }
                        }
                    }

                    connection.Close();
                }
            }
            catch (Exception ex)
            {
                // Log or handle the exception as needed
                return false;
            }
        }

        private Product GetProductFromDatabase(int productID)
        {
            Product product = null;

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();

                using (SqlCommand command = new SqlCommand("SELECT * FROM Product WHERE ProductID = @ProductID", connection))
                {
                    command.Parameters.AddWithValue("@ProductID", productID);

                    using (SqlDataReader reader = command.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            product = new Product(
                            (int)reader["ProductID"],
                            reader["ProductName"].ToString(),
                            (decimal)reader["Price"],
                            reader["Description"].ToString(),
                            reader["ImageUrl"].ToString()
                    );
                        }
                    }
                }

                connection.Close();
            }

            return product;
        }

        private void DisplayErrorMessage(Label errorMessageLabel, string message)
        {
            errorMessageLabel.Text = message;
            errorMessageLabel.Visible = true;
        }

    }
}

using (var connection = new SqlConnection(connectionString))
                        {
                            connection.Open();

                            // Check if the user is an admin
                            using (var command = new SqlCommand("SELECT UserType FROM Users WHERE Username = @Username", connection))
                            {
                                command.Parameters.AddWithValue("@Username", username);

                                var userType = command.ExecuteScalar() as string;

                                if (userType != null && userType == "admin")
                                {
                                    // User is an admin, make the buttons visible
                                    btnUpdateProduct.Visible = true;
                                    btnDeleteProduct.Visible = true;
                                }
                                else if (userType != null && userType == "customer")
                                {
                                    // User is a customer, hide the buttons
                                    btnUpdateProduct.Visible = false;
                                    btnDeleteProduct.Visible = false;
                                }
                            }

                            connection.Close();
                        }